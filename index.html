<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Depth & Tone Analyzer</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        canvas { width: 100%; height: 100%; }
        
        /* Pulse Animation for Recording */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .recording-pulse::before {
            content: '';
            position: absolute;
            left: 0; top: 0; width: 100%; height: 100%;
            border-radius: 50%;
            background-color: #EF4444;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            z-index: -1;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
        
        <!-- Header -->
        <div class="gradient-bg p-6 text-white text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-10">
                <i class="fas fa-wave-square text-9xl absolute -right-4 -top-4"></i>
            </div>
            <h1 class="text-2xl font-bold relative z-10"><i class="fas fa-microphone-lines mr-2"></i>Vocal Analyzer</h1>
            <p class="text-indigo-100 text-sm mt-1 relative z-10">Read & Discover your Voice Profile</p>
        </div>

        <!-- Content Area -->
        <div class="p-6 space-y-6">

            <!-- Practice Card -->
            <div class="bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl p-6 text-center relative group transition-all hover:border-indigo-400">
                <span class="absolute top-3 left-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Read Aloud</span>
                <button onclick="changeSentence()" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 p-2 transition-colors" title="Change Text">
                    <i class="fas fa-sync-alt"></i>
                </button>
                
                <p id="text-prompt" class="text-xl text-slate-800 font-medium mt-4 leading-relaxed">
                    "The quick brown fox jumps over the lazy dog."
                </p>
            </div>

            <!-- Visualizer -->
            <div class="h-24 bg-black rounded-lg overflow-hidden relative shadow-inner">
                <canvas id="visualizer"></canvas>
                <div id="status-overlay" class="absolute inset-0 flex items-center justify-center text-slate-500 text-xs font-mono">
                    <span id="status-text">Ready to Record</span>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex justify-center gap-4">
                <button id="btn-start" onclick="startAnalysis()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105 shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                    <i class="fas fa-microphone"></i> Start
                </button>
                
                <button id="btn-stop" onclick="stopAnalysis()" disabled class="flex-1 bg-slate-200 text-slate-400 font-bold py-3 px-6 rounded-xl transition cursor-not-allowed flex items-center justify-center gap-2 relative">
                    <div id="recording-indicator" class="hidden w-3 h-3 bg-red-500 rounded-full absolute top-2 right-2 recording-pulse"></div>
                    <i class="fas fa-stop"></i> Analyze
                </button>
            </div>

            <!-- Results Section (Hidden by Default) -->
            <div id="results-area" class="hidden space-y-4 animate-fade-in">
                <div class="h-px bg-slate-200 w-full my-2"></div>
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wide">Analysis Results</h3>
                
                <!-- Metric: Depth -->
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl flex items-center justify-between">
                    <div>
                        <div class="text-xs font-bold text-blue-600 uppercase">Voice Depth</div>
                        <div class="text-lg font-bold text-slate-800 mt-1"><span id="res-pitch">0</span> Hz</div>
                        <div id="res-depth-label" class="text-sm text-blue-800 font-medium">Analyzing...</div>
                    </div>
                    <div class="h-10 w-10 bg-blue-200 rounded-full flex items-center justify-center text-blue-600">
                        <i class="fas fa-arrow-down-long"></i>
                    </div>
                </div>

                <!-- Metric: Tone -->
                <div class="bg-purple-50 border border-purple-100 p-4 rounded-xl flex items-center justify-between">
                    <div>
                        <div class="text-xs font-bold text-purple-600 uppercase">Tone Variation</div>
                        <div class="text-lg font-bold text-slate-800 mt-1"><span id="res-var">0</span></div>
                        <div id="res-tone-label" class="text-sm text-purple-800 font-medium">Analyzing...</div>
                    </div>
                    <div class="h-10 w-10 bg-purple-200 rounded-full flex items-center justify-center text-purple-600">
                        <i class="fas fa-wave-square text-xs"></i>
                    </div>
                </div>

                <!-- Summary -->
                <div class="bg-slate-100 p-3 rounded-lg text-xs text-slate-600 leading-relaxed italic" id="res-summary">
                    Analysis complete.
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const sentences = [
            "The quick brown fox jumps over the lazy dog.",
            "Success is not final, failure is not fatal.",
            "To be or not to be, that is the question.",
            "A journey of a thousand miles begins with a single step.",
            "Hello world, I am testing my voice today."
        ];

        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;
        let isRecording = false;
        let pitchSamples = [];
        let animationId;

        // --- DOM Elements ---
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const statusText = document.getElementById('status-text');
        const resultsArea = document.getElementById('results-area');
        const recordingIndicator = document.getElementById('recording-indicator');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        // --- Core Functions ---

        function changeSentence() {
            const index = Math.floor(Math.random() * sentences.length);
            document.getElementById('text-prompt').innerText = `"${sentences[index]}"`;
            resetUI();
        }

        function resetUI() {
            resultsArea.classList.add('hidden');
            statusText.innerText = "Ready to Record";
            statusText.parentElement.style.opacity = "1";
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        }

        async function startAnalysis() {
            try {
                // Initialize Audio Context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;

                // Get Microphone Stream
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                // Start Visualizer & Data Collection
                isRecording = true;
                pitchSamples = [];
                updateUIState(true);
                visualize();
                collectData();

            } catch (err) {
                alert("Microphone access denied or not supported. Please allow permissions.");
                console.error(err);
            }
        }

        function stopAnalysis() {
            if (!isRecording) return;
            
            isRecording = false;
            cancelAnimationFrame(animationId);
            
            if (microphone) microphone.disconnect();
            if (audioContext) audioContext.close();

            updateUIState(false);
            processAudioData();
        }

        // --- UI State Management ---
        function updateUIState(recording) {
            if (recording) {
                btnStart.disabled = true;
                btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                btnStop.disabled = false;
                btnStop.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                btnStop.classList.add('bg-slate-800', 'text-white', 'hover:bg-black');
                statusText.parentElement.style.opacity = "0"; // Hide "Ready" text
                recordingIndicator.classList.remove('hidden');
            } else {
                btnStart.disabled = false;
                btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                btnStop.disabled = true;
                btnStop.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                btnStop.classList.remove('bg-slate-800', 'text-white', 'hover:bg-black');
                recordingIndicator.classList.add('hidden');
            }
        }

        // --- Visualizer ---
        function visualize() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            const draw = () => {
                if (!isRecording) return;
                animationId = requestAnimationFrame(draw);

                analyser.getByteTimeDomainData(dataArray);

                canvasCtx.fillStyle = 'rgb(0, 0, 0)';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = '#818cf8'; // Indigo-400
                canvasCtx.beginPath();

                const sliceWidth = canvas.width * 1.0 / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * canvas.height / 2;

                    if (i === 0) canvasCtx.moveTo(x, y);
                    else canvasCtx.lineTo(x, y);

                    x += sliceWidth;
                }

                canvasCtx.lineTo(canvas.width, canvas.height / 2);
                canvasCtx.stroke();
            };
            draw();
        }

        // --- Data Collection Loop ---
        function collectData() {
            if (!isRecording) return;

            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);

            const pitch = autoCorrelate(buffer, audioContext.sampleRate);
            
            // Filter out silence (-1) and extremely high/low noise
            if (pitch !== -1 && pitch > 50 && pitch < 1000) {
                pitchSamples.push(pitch);
            }

            // Collect data every 50ms
            setTimeout(collectData, 50); 
        }

        // --- Physics & Algorithms (Autocorrelation) ---
        function autoCorrelate(buf, sampleRate) {
            let size = buf.length;
            let rms = 0;

            // 1. Calculate RMS (Volume) to detect silence
            for (let i = 0; i < size; i++) {
                const val = buf[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / size);
            if (rms < 0.02) return -1; // Silence

            // 2. Autocorrelation
            let r1 = 0, r2 = size - 1, thres = 0.2;
            for (let i = 0; i < size / 2; i++) {
                if (Math.abs(buf[i]) < thres) { r1 = i; break; }
            }
            for (let i = 1; i < size / 2; i++) {
                if (Math.abs(buf[size - i]) < thres) { r2 = size - i; break; }
            }

            const newBuf = buf.slice(r1, r2);
            size = newBuf.length;

            const c = new Array(size).fill(0);
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size - i; j++) {
                    c[i] = c[i] + newBuf[j] * newBuf[j + i];
                }
            }

            let d = 0; while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < size; i++) {
                if (c[i] > maxval) {
                    maxval = c[i];
                    maxpos = i;
                }
            }
            let T0 = maxpos;

            return sampleRate / T0;
        }

        // --- Result Processing ---
        function processAudioData() {
            resultsArea.classList.remove('hidden');

            if (pitchSamples.length < 5) {
                document.getElementById('res-pitch').innerText = "--";
                document.getElementById('res-depth-label').innerText = "Audio too short/quiet";
                document.getElementById('res-summary').innerText = "Please speak louder or longer.";
                return;
            }

            // 1. Calculate Average Pitch
            const sum = pitchSamples.reduce((a, b) => a + b, 0);
            const avgPitch = Math.round(sum / pitchSamples.length);

            // 2. Calculate Variance (Standard Deviation)
            const squareDiffs = pitchSamples.map(value => Math.pow(value - avgPitch, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
            const stdDev = Math.round(Math.sqrt(avgSquareDiff));

            // 3. Determine Labels
            let depthLabel = "Unknown";
            let depthSummary = "";
            
            // Basic Frequency Ranges
            if (avgPitch < 110) { depthLabel = "Deep / Bass"; depthSummary = "Your voice has a very strong, deep resonance."; }
            else if (avgPitch < 165) { depthLabel = "Moderate / Baritone"; depthSummary = "You have a balanced, standard male-range pitch."; }
            else if (avgPitch < 220) { depthLabel = "Neutral / Alto"; depthSummary = "Your voice is in a neutral range, common for female voices or higher male voices."; }
            else { depthLabel = "High / Soprano"; depthSummary = "Your voice is bright and carries well at a higher frequency."; }

            let toneLabel = "Neutral";
            let toneSummary = "";

            if (stdDev < 5) { toneLabel = "Monotone"; toneSummary = "Your pitch is very steady. Try adding more emotion for emphasis."; }
            else if (stdDev < 25) { toneLabel = "Stable"; toneSummary = "Your speech is clear and controlled."; }
            else { toneLabel = "Expressive"; toneSummary = "You use a lot of dynamic range in your speech, which is engaging."; }

            // 4. Update UI
            document.getElementById('res-pitch').innerText = avgPitch;
            document.getElementById('res-depth-label').innerText = depthLabel;
            
            document.getElementById('res-var').innerText = stdDev;
            document.getElementById('res-tone-label').innerText = toneLabel;
            
            document.getElementById('res-summary').innerText = `${depthSummary} ${toneSummary}`;
        }
    </script>
</body>
</html>

