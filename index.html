<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Match & Frequency Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #111827; color: #f3f4f6; }
        
        /* Mic Button Pulse Animation */
        @keyframes ripple {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
            70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .recording {
            animation: ripple 1.5s infinite;
            background-color: #ef4444 !important; /* Red when recording */
            transform: scale(1.05);
        }

        /* Success/Fail Animations */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-gray-900 rounded-3xl shadow-2xl border border-gray-800 overflow-hidden relative">
        
        <!-- Header -->
        <div class="bg-gray-800 p-5 text-center border-b border-gray-700">
            <h1 class="text-xl font-bold text-white flex justify-center items-center gap-2">
                <i class="fas fa-fingerprint text-blue-500"></i> Voice Match Test
            </h1>
            <p class="text-xs text-gray-400 mt-1">Say the words below to test your frequency</p>
        </div>

        <div class="p-8 flex flex-col items-center">
            
            <!-- Target Phrase -->
            <div class="text-center mb-8 w-full">
                <p class="text-xs text-blue-400 font-bold uppercase tracking-widest mb-2">Target Phrase</p>
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700 relative group">
                    <button onclick="generatePhrase()" class="absolute top-2 right-2 text-gray-500 hover:text-white transition-colors" title="Change words">
                        <i class="fas fa-sync-alt text-sm"></i>
                    </button>
                    <h2 id="target-text" class="text-3xl font-extrabold text-white tracking-tight">Blue sky</h2>
                </div>
            </div>

            <!-- Big Mic Button -->
            <div class="relative flex justify-center items-center mb-8 h-32">
                <button id="mic-btn" onclick="toggleTest()" class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center text-white text-3xl shadow-lg transition-all duration-300 hover:bg-blue-500 z-10">
                    <i id="mic-icon" class="fas fa-microphone"></i>
                </button>
                <div id="listen-status" class="absolute -bottom-6 text-sm text-gray-400 font-medium tracking-wide opacity-0 transition-opacity">Listening...</div>
            </div>

            <!-- Visualizer -->
            <div class="w-full h-16 bg-gray-950 rounded-lg overflow-hidden border border-gray-800 mb-6 relative">
                <canvas id="visualizer" class="w-full h-full"></canvas>
            </div>

            <!-- Error Message Box -->
            <div id="error-box" class="hidden w-full bg-red-900/30 border border-red-800 text-red-400 text-sm p-3 rounded-lg text-center mb-4">
                Error message goes here.
            </div>

            <!-- Results Section -->
            <div id="results-area" class="hidden w-full space-y-4 animate-pop">
                <div class="border-t border-gray-800 pt-6"></div>
                
                <!-- Match Status -->
                <div id="match-card" class="rounded-xl p-4 text-center border border-gray-700">
                    <div id="match-icon" class="text-4xl mb-2">✅</div>
                    <h3 id="match-title" class="text-lg font-bold text-white mb-1">Perfect Match!</h3>
                    <p class="text-sm text-gray-400">You said: <span id="user-transcript" class="text-white font-semibold">"Blue sky"</span></p>
                </div>

                <!-- Frequency Range -->
                <div class="bg-gray-800 rounded-xl p-4 flex items-center justify-between border border-gray-700">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-indigo-900/50 flex items-center justify-center text-indigo-400">
                            <i class="fas fa-wave-square"></i>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 font-bold uppercase">Frequency Range</div>
                            <div class="text-gray-500 text-xs mt-0.5">Min - Max Pitch</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="freq-range" class="text-lg font-bold text-white">120 - 240 Hz</div>
                        <div class="text-xs text-indigo-400 mt-0.5">Avg: <span id="freq-avg">180</span> Hz</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Word Bank (2-3 words) ---
        const phrases = [
            "Blue sky", "Hello world", "Voice test", "Red apple", 
            "Good morning", "Open door", "Dark night", "Green tree", 
            "Cold water", "Warm sun", "Speak loud", "Clear tone"
        ];

        // --- State ---
        let targetPhrase = "";
        let isTesting = false;
        
        // Audio & Speech Recognition Objects
        let recognition = null;
        let audioCtx, analyser, microphone;
        let animationId;
        let pitchSamples = [];

        // UI Elements
        const targetTextEl = document.getElementById('target-text');
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        const listenStatus = document.getElementById('listen-status');
        const resultsArea = document.getElementById('results-area');
        const errorBox = document.getElementById('error-box');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        // --- Initialization ---
        function init() {
            generatePhrase();
            
            // Check Speech Recognition Support
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (window.SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = handleSpeechResult;
                recognition.onerror = handleSpeechError;
                recognition.onspeechend = stopTestEnvironment;
            } else {
                showError("Speech Recognition is not supported in this browser. Please use Google Chrome or Edge.");
                micBtn.disabled = true;
                micBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function generatePhrase() {
            targetPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            targetTextEl.innerText = targetPhrase;
            hideResults();
        }

        function showError(msg) {
            errorBox.innerText = msg;
            errorBox.classList.remove('hidden');
        }
        function hideError() {
            errorBox.classList.add('hidden');
        }
        function hideResults() {
            resultsArea.classList.add('hidden');
        }

        // --- Test Execution ---
        async function toggleTest() {
            if (isTesting) {
                stopTestEnvironment();
                return;
            }

            hideError();
            hideResults();
            pitchSamples = [];

            try {
                // 1. Setup Audio Frequency Analyzer
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioCtx.createMediaStreamSource(stream);
                microphone.connect(analyser);

                // 2. Start Speech Recognition
                recognition.start();

                // 3. Update UI
                isTesting = true;
                micBtn.classList.add('recording');
                micIcon.classList.replace('fa-microphone', 'fa-stop');
                listenStatus.style.opacity = "1";
                
                // 4. Start processing audio data
                processAudioLoop();

            } catch (err) {
                showError("Microphone access denied. Please allow permissions.");
                console.error(err);
            }
        }

        function stopTestEnvironment() {
            if (!isTesting) return;
            isTesting = false;
            
            // UI Updates
            micBtn.classList.remove('recording');
            micIcon.classList.replace('fa-stop', 'fa-microphone');
            listenStatus.style.opacity = "0";

            // Stop Recognition & Audio
            try { recognition.stop(); } catch(e){}
            cancelAnimationFrame(animationId);
            if(microphone) microphone.disconnect();
            if(audioCtx) audioCtx.close();
        }

        // --- Data Collection (Real-time) ---
        function processAudioLoop() {
            if (!isTesting) return;
            animationId = requestAnimationFrame(processAudioLoop);

            const bufferLength = analyser.frequencyBinCount;
            const floatData = new Float32Array(analyser.fftSize);
            const byteData = new Uint8Array(bufferLength);
            
            analyser.getFloatTimeDomainData(floatData);
            analyser.getByteTimeDomainData(byteData);

            // Calculate Pitch
            const pitch = autoCorrelate(floatData, audioCtx.sampleRate);
            if (pitch !== -1 && pitch > 60 && pitch < 600) {
                pitchSamples.push(pitch);
            }

            // Draw Visualizer
            drawVisualizer(byteData, bufferLength);
        }

        function drawVisualizer(dataArray, bufferLength) {
            canvasCtx.fillStyle = '#030712'; // gray-950
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = isTesting ? '#ef4444' : '#3b82f6'; // Red if recording, Blue otherwise
            canvasCtx.beginPath();

            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2;
                if (i === 0) canvasCtx.moveTo(x, y);
                else canvasCtx.lineTo(x, y);
                x += sliceWidth;
            }
            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();
        }

        // --- Results Processing ---
        function handleSpeechResult(event) {
            stopTestEnvironment();
            const transcript = event.results[0][0].transcript.trim();
            analyzeResults(transcript);
        }

        function handleSpeechError(event) {
            stopTestEnvironment();
            if(event.error === 'no-speech') {
                showError("No speech detected. Please try again.");
            } else {
                showError("Speech recognition error: " + event.error);
            }
        }

        function analyzeResults(transcript) {
            // 1. Text Match Logic
            // Clean strings (remove punctuation, lowercase) for fair comparison
            const cleanTarget = targetPhrase.toLowerCase().replace(/[^a-z0-9 ]/g, '');
            const cleanTranscript = transcript.toLowerCase().replace(/[^a-z0-9 ]/g, '');
            
            const isMatch = cleanTarget === cleanTranscript;

            // 2. Frequency Range Logic
            let minPitch = 0, maxPitch = 0, avgPitch = 0;
            
            if (pitchSamples.length > 0) {
                minPitch = Math.round(Math.min(...pitchSamples));
                maxPitch = Math.round(Math.max(...pitchSamples));
                const sum = pitchSamples.reduce((a, b) => a + b, 0);
                avgPitch = Math.round(sum / pitchSamples.length);
            }

            // 3. Update UI
            document.getElementById('user-transcript').innerText = `"${transcript}"`;
            
            const matchCard = document.getElementById('match-card');
            const matchTitle = document.getElementById('match-title');
            const matchIcon = document.getElementById('match-icon');

            if (isMatch) {
                matchCard.className = "rounded-xl p-4 text-center border bg-green-900/20 border-green-800";
                matchTitle.className = "text-lg font-bold text-green-400 mb-1";
                matchTitle.innerText = "Perfect Match!";
                matchIcon.innerText = "✅";
            } else {
                matchCard.className = "rounded-xl p-4 text-center border bg-red-900/20 border-red-800";
                matchTitle.className = "text-lg font-bold text-red-400 mb-1";
                matchTitle.innerText = "Mismatch";
                matchIcon.innerText = "❌";
            }

            if (pitchSamples.length < 5) {
                document.getElementById('freq-range').innerText = "Insufficient Data";
                document.getElementById('freq-avg').innerText = "--";
            } else {
                document.getElementById('freq-range').innerText = `${minPitch} - ${maxPitch} Hz`;
                document.getElementById('freq-avg').innerText = avgPitch;
            }

            resultsArea.classList.remove('hidden');
        }

        // --- Pitch Algorithm ---
        function autoCorrelate(buf, sampleRate) {
            let size = buf.length;
            let rms = 0;
            for (let i = 0; i < size; i++) rms += buf[i] * buf[i];
            rms = Math.sqrt(rms / size);
            if (rms < 0.02) return -1; // Ignore silence/noise

            let r1 = 0, r2 = size - 1, thres = 0.2;
            for (let i = 0; i < size / 2; i++) {
                if (Math.abs(buf[i]) < thres) { r1 = i; break; }
            }
            for (let i = 1; i < size / 2; i++) {
                if (Math.abs(buf[size - i]) < thres) { r2 = size - i; break; }
            }
            
            const newBuf = buf.slice(r1, r2);
            size = newBuf.length;

            const c = new Array(size).fill(0);
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size - i; j++) {
                    c[i] = c[i] + newBuf[j] * newBuf[j + i];
                }
            }
            let d = 0; while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < size; i++) {
                if (c[i] > maxval) {
                    maxval = c[i];
                    maxpos = i;
                }
            }
            let T0 = maxpos;
            return sampleRate / T0;
        }

        // Boot
        window.onload = init;
    </script>
</body>
</html>

